<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحليل شرعي - سندات قابلة للتحويل 800,000 ريال عماني</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #00a19f 0%, #0a3433 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #00a19f;
        }
        
        .section-number {
            background: linear-gradient(135deg, #00a19f 0%, #0a3433 100%);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(0,161,159,0.3);
        }
        
        .section-title {
            font-size: 28px;
            font-weight: 800;
            color: #0a3433;
            margin: 0;
        }
        
        .warning-box {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border: 3px solid #ffffff;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .info-card {
            background: linear-gradient(135deg, rgba(0,161,159,0.1) 0%, rgba(10,52,51,0.1) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(0,161,159,0.2);
        }
        
        .problematic-card {
            background: linear-gradient(135deg, rgba(220,53,69,0.1) 0%, rgba(200,35,51,0.1) 100%);
            border: 2px solid rgba(220,53,69,0.3);
        }
        
        .scenario-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .scenario-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            border: 3px solid rgba(0,161,159,0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .scenario-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: #00a19f;
            box-shadow: 0 15px 30px rgba(0,161,159,0.2);
        }
        
        .scenario-card.active {
            background: linear-gradient(135deg, #00a19f 0%, #0a3433 100%);
            color: white;
            border-color: white;
            transform: translateY(-5px) scale(1.05);
        }
        
        .scenario-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #00a19f 0%, #0a3433 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .scenario-card.active .scenario-icon {
            background: rgba(255,255,255,0.2);
        }
        
        .results-container {
            background: linear-gradient(135deg, rgba(0,161,159,0.05) 0%, rgba(10,52,51,0.05) 100%);
            border: 2px solid rgba(0,161,159,0.2);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .calculation-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
            align-items: center;
        }
        
        .calc-label {
            font-size: 18px;
            font-weight: 600;
            color: #0a3433;
        }
        
        .calc-value {
            font-size: 24px;
            font-weight: 800;
            color: #00a19f;
            text-align: left;
            direction: ltr;
        }
        
        .final-outcome {
            background: linear-gradient(135deg, #28a745 0%, #155724 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin: 30px 0;
        }
        
        .variable-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(0,161,159,0.3);
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
            background: rgba(255,255,255,0.9);
            transition: all 0.3s ease;
        }
        
        .variable-input:focus {
            outline: none;
            border-color: #00a19f;
            box-shadow: 0 0 0 3px rgba(0,161,159,0.2);
        }
        
        .conclusion-section {
            background: linear-gradient(135deg, #28a745 0%, #155724 100%);
            color: white;
        }
        
        .conclusion-section .section-number {
            background: rgba(255,255,255,0.2);
        }
        
        .conclusion-section .section-title {
            color: white;
        }
        
        .recommendation-box {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .hidden {
            display: none;
        }
        
        h3 {
            color: #0a3433;
            font-size: 22px;
            font-weight: 700;
            margin: 20px 0 15px 0;
        }
        
        p, li {
            color: #0a3433;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .problematic-highlight {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        ul {
            margin-right: 20px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }
        
        .step-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: rgba(0,161,159,0.3);
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background: #00a19f;
            transform: scale(1.3);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Section 1: Introduction & Overview -->
        <div class="section">
            <div class="section-header">
                <div class="section-number">1</div>
                <h1 class="section-title">نظرة عامة على الصفقة</h1>
            </div>
            
            <p style="font-size: 20px; margin-bottom: 25px;">
                <strong>الهدف:</strong> تحليل شرعي لسند قابل للتحويل بقيمة 800,000 ريال عماني لشركة زراعية عمانية
            </p>
            
            <div class="warning-box">
                <h3 style="color: white; margin-top: 0;">⚠️ ملخص المخاوف الشرعية الأساسية</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div>
                        <strong>1️⃣ ربا النسيئة:</strong><br>
                        فائدة ثابتة 10% سنوياً على القرض
                    </div>
                    <div>
                        <strong>2️⃣ ربا الفضل:</strong><br>
                        خصم 20% في بعض سيناريوهات التحويل
                    </div>
                </div>
            </div>
            
            <p><strong>ما سنحلله:</strong> كيف تعمل آلية التحويل في كل سيناريو وأين تكمن المشاكل الشرعية تحديداً.</p>
        </div>

        <!-- Section 2: Fixed Contract Terms -->
        <div class="section">
            <div class="section-header">
                <div class="section-number">2</div>
                <h1 class="section-title">الشروط الثابتة في العقد</h1>
            </div>
            
            <p>هذه الشروط محددة في العقد ولا يمكن تغييرها:</p>
            
            <div class="info-grid">
                <div class="info-card">
                    <h3>💰 التفاصيل المالية الأساسية</h3>
                    <ul>
                        <li><strong>المبلغ الأصلي:</strong> 800,000 ريال عماني</li>
                        <li><strong>تاريخ الإصدار:</strong> 31 يوليو 2026</li>
                        <li><strong>تاريخ الاستحقاق:</strong> 31 يوليو 2029 (3 سنوات)</li>
                        <li><strong>الحد الأقصى للتقييم:</strong> 4,000,000 ريال عماني</li>
                    </ul>
                </div>
                
                <div class="info-card problematic-card">
                    <h3>⚠️ العناصر المثيرة للقلق شرعياً</h3>
                    <ul>
                        <li><strong>معدل الفائدة:</strong> <span class="problematic-highlight">10% سنوياً (بسيط)</span></li>
                        <li><strong>خصم التحويل:</strong> <span class="problematic-highlight">20% في بعض الحالات</span></li>
                        <li><strong>طبيعة الأداة:</strong> دين يحمل فائدة محددة مسبقاً</li>
                    </ul>
                </div>
                
                <div class="info-card">
                    <h3>🎯 أحداث التحويل</h3>
                    <ul>
                        <li><strong>تحقيق الأرباح:</strong> 614,000 ريال عماني (12 شهر)</li>
                        <li><strong>التمويل المؤهل:</strong> جولة استثمارية جديدة</li>
                        <li><strong>التحويل الاختياري:</strong> بعد 31 يوليو 2027</li>
                        <li><strong>حدث السيولة:</strong> بيع الشركة أو طرح عام</li>
                    </ul>
                </div>
                
                <div class="info-card">
                    <h3>🛡️ حماية المستثمر</h3>
                    <ul>
                        <li><strong>استخدام الأموال:</strong> توسع المزرعة، رأس المال العامل</li>
                        <li><strong>حقوق المعلومات:</strong> تقارير ربع سنوية ومدققة</li>
                        <li><strong>قيود على الشركة:</strong> لا يمكن إصدار أسهم جديدة بدون موافقة</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Section 3: Scenario Analysis -->
        <div class="section">
            <div class="section-header">
                <div class="section-number">3</div>
                <h1 class="section-title">تحليل السيناريوهات</h1>
            </div>
            
            <p>اختر سيناريو لفهم كيفية عمل التحويل والمخاوف الشرعية في كل حالة:</p>
            
            <div class="scenario-selector">
                <div class="scenario-card active" data-scenario="equity">
                    <div class="scenario-icon">💸</div>
                    <h3 style="margin: 0; color: inherit;">التمويل المؤهل</h3>
                    <p style="margin: 10px 0 0 0; color: inherit; font-size: 14px;">جولة استثمارية جديدة</p>
                    <div style="background: rgba(220,53,69,0.2); padding: 5px; border-radius: 5px; margin-top: 10px; font-size: 12px;">
                        ⚠️ يتضمن خصم 20%
                    </div>
                </div>
                
                <div class="scenario-card" data-scenario="ebitda">
                    <div class="scenario-icon">📊</div>
                    <h3 style="margin: 0; color: inherit;">تحقيق الأرباح</h3>
                    <p style="margin: 10px 0 0 0; color: inherit; font-size: 14px;">614,000 ريال عماني</p>
                </div>
                
                <div class="scenario-card" data-scenario="optional">
                    <div class="scenario-icon">🔄</div>
                    <h3 style="margin: 0; color: inherit;">التحويل الاختياري</h3>
                    <p style="margin: 10px 0 0 0; color: inherit; font-size: 14px;">بعد يوليو 2027</p>
                </div>
                
                <div class="scenario-card" data-scenario="backstop">
                    <div class="scenario-icon">⏰</div>
                    <h3 style="margin: 0; color: inherit;">الاستحقاق</h3>
                    <p style="margin: 10px 0 0 0; color: inherit; font-size: 14px;">يوليو 2029</p>
                </div>
            </div>
            
            <div id="scenarioInputs" style="margin: 30px 0;">
                <!-- Dynamic inputs -->
            </div>
            
            <div class="results-container" id="calculationResults">
                <!-- Results will be shown here -->
            </div>
        </div>

        <!-- Section 4: Shariah Analysis -->
        <div class="section">
            <div class="section-header">
                <div class="section-number">4</div>
                <h1 class="section-title">التحليل الشرعي التفصيلي</h1>
            </div>
            
            <div class="info-grid">
                <div class="info-card problematic-card">
                    <h3>❌ العناصر المحرمة قطعياً</h3>
                    <ul>
                        <li><strong>ربا النسيئة:</strong> فائدة 10% محددة مسبقاً على القرض</li>
                        <li><strong>ربا الفضل:</strong> خصم 20% يضمن عائداً أعلى مقابل القرض</li>
                        <li><strong>الجمع بين القرض والمنفعة:</strong> القرض الذي يجر نفعاً محرم</li>
                    </ul>
                </div>
                
                <div class="info-card">
                    <h3>⚖️ العناصر القابلة للتطوير</h3>
                    <ul>
                        <li><strong>آلية التحويل:</strong> فكرة التحول من دين لملكية مقبولة</li>
                        <li><strong>استخدام الأموال:</strong> في أنشطة حلال (زراعة)</li>
                        <li><strong>حقوق المعلومات:</strong> شفافية وحماية المستثمر</li>
                        <li><strong>القيود على الشركة:</strong> منع سوء الاستخدام</li>
                    </ul>
                </div>
            </div>
            
            <div class="warning-box">
                <h3 style="color: white; margin-top: 0;">🎯 خلاصة التقييم الشرعي</h3>
                <p style="color: white; font-size: 18px; margin: 0;">
                    <strong>الحكم:</strong> الهيكل الحالي غير متوافق مع الشريعة الإسلامية بسبب عنصري الفائدة والخصم. 
                    يحتاج إلى إعادة هيكلة جوهرية لإزالة عناصر الربا.
                </p>
            </div>
        </div>

        <!-- Section 5: Recommendations -->
        <div class="section conclusion-section">
            <div class="section-header">
                <div class="section-number">5</div>
                <h1 class="section-title">التوصيات والبدائل الشرعية</h1>
            </div>
            
            <div class="recommendation-box">
                <h3 style="color: white;">✅ البدائل الشرعية المقترحة</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div>
                        <h4 style="color: white; font-size: 18px;">1️⃣ نموذج المشاركة المتناقصة</h4>
                        <ul style="color: white;">
                            <li>شراكة في المزرعة تتناقص تدريجياً</li>
                            <li>ربح بدلاً من فائدة ثابتة</li>
                            <li>مخاطر مشتركة</li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="color: white; font-size: 18px;">2️⃣ نموذج المضاربة</h4>
                        <ul style="color: white;">
                            <li>شراكة في الأرباح فقط</li>
                            <li>لا فوائد ثابتة</li>
                            <li>نسب محددة من الأرباح</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="recommendation-box">
                <h3 style="color: white;">📋 الخطوات المقترحة</h3>
                <ol style="color: white; margin-right: 20px;">
                    <li><strong>إعادة هيكلة كاملة:</strong> إزالة عنصر الفائدة الثابتة</li>
                    <li><strong>استبدال آلية الخصم:</strong> بنظام عادل لا يضمن عائداً مسبقاً</li>
                    <li><strong>اعتماد نموذج شراكة:</strong> يحقق المصالح دون مخالفة شرعية</li>
                    <li><strong>مراجعة شرعية دورية:</strong> لضمان الالتزام المستمر</li>
                </ol>
            </div>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step-dot active"></div>
            <div class="step-dot active"></div>
            <div class="step-dot active"></div>
            <div class="step-dot active"></div>
            <div class="step-dot active"></div>
        </div>
    </div>

    <script>
        // Contract terms (fixed)
        const CONTRACT = {
            principal: 800000,
            interestRate: 10,
            issuanceDate: '2026-07-31',
            maturityDate: '2029-07-31',
            ebitdaTarget: 614000,
            valuationCap: 4000000,
            discountRate: 0.8,
            optionalDate: '2027-07-31'
        };

        // Variables
        const variables = {
            currentDate: '2027-12-31',
            nextRoundPrice: 2,
            currentShares: 1000000,
            ebitdaAchieved: 614000,
            liquidityPrice: 3,
            fairMarketValue: 4
        };

        let currentScenario = 'equity';

        function formatNumber(num) {
            return num.toLocaleString('ar-EG');
        }

        function calculateInterest(principal, rate, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return (principal * rate / 100 * days) / 365;
        }

        function updateScenarioInputs(scenario) {
            const container = document.getElementById('scenarioInputs');
            let html = '<h3>متغيرات السيناريو (قيم افتراضية للتحليل):</h3>';

            switch (scenario) {
                case 'equity':
                    html += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">سعر الجولة التالية (ريال عماني/سهم):</label>
                                <input type="number" step="0.01" class="variable-input" value="${variables.nextRoundPrice}" 
                                       onchange="variables.nextRoundPrice = parseFloat(this.value); calculateScenario();">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">الأسهم المتداولة الحالية:</label>
                                <input type="number" class="variable-input" value="${variables.currentShares}" 
                                       onchange="variables.currentShares = parseInt(this.value); calculateScenario();">
                            </div>
                        </div>
                    `;
                    break;
                case 'ebitda':
                    html += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">الأرباح المحققة (ريال عماني):</label>
                                <input type="number" class="variable-input" value="${variables.ebitdaAchieved}" 
                                       onchange="variables.ebitdaAchieved = parseInt(this.value); calculateScenario();">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">الأسهم المتداولة الحالية:</label>
                                <input type="number" class="variable-input" value="${variables.currentShares}" 
                                       onchange="variables.currentShares = parseInt(this.value); calculateScenario();">
                            </div>
                        </div>
                    `;
                    break;
                case 'optional':
                    html += `
                        <div style="margin-top: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;">الأسهم المتداولة الحالية:</label>
                            <input type="number" class="variable-input" value="${variables.currentShares}" 
                                   onchange="variables.currentShares = parseInt(this.value); calculateScenario();">
                        </div>
                    `;
                    break;
                case 'backstop':
                    html += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">القيمة السوقية العادلة (ريال عماني/سهم):</label>
                                <input type="number" step="0.01" class="variable-input" value="${variables.fairMarketValue}" 
                                       onchange="variables.fairMarketValue = parseFloat(this.value); calculateScenario();">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">الأسهم المتداولة الحالية:</label>
                                <input type="number" class="variable-input" value="${variables.currentShares}" 
                                       onchange="variables.currentShares = parseInt(this.value); calculateScenario();">
                            </div>
                        </div>
                    `;
                    break;
            }

            container.innerHTML = html;
            calculateScenario();
        }

        function calculateScenario() {
            const interest = calculateInterest(CONTRACT.principal, CONTRACT.interestRate, CONTRACT.issuanceDate, variables.currentDate);
            const totalAmount = CONTRACT.principal + interest;
            const container = document.getElementById('calculationResults');
            
            let result = '';
            let shariahConcern = '';

            switch (currentScenario) {
                case 'equity':
                    const discountPrice = variables.nextRoundPrice * CONTRACT.discountRate;
                    const capPrice = CONTRACT.valuationCap / variables.currentShares;
                    const conversionPrice = Math.min(discountPrice, capPrice);
                    const shares = Math.floor(totalAmount / conversionPrice);
                    
                    shariahConcern = '<div class="warning-box" style="margin: 20px 0;"><strong>⚠️ مخاوف شرعية:</strong> خصم 20% يعتبر ربا فضل - منفعة إضافية مقابل القرض</div>';
                    
                    result = `
                        <h3>💸 سيناريو التمويل المؤهل</h3>
                        <div class="calculation-row">
                            <div class="calc-label">المبلغ الأصلي + الفائدة المتراكمة:</div>
                            <div class="calc-value">${formatNumber(Math.round(totalAmount))} ريال عماني</div>
                        </div>
                        <div class="calculation-row">
                            <div class="calc-label">سعر الجولة الجديدة:</div>
                            <div class="calc-value">${variables.nextRoundPrice} ريال عماني/سهم</div>
                        </div>
                        <div class="calculation-row">
                            <div class="calc-label">السعر بعد خصم 20%:</div>
                            <div class="calc-value">${discountPrice.toFixed(4)} ريال عماني/سهم</div>
                        </div>
                        <div class="calculation-row">
                            <div class="calc-label">سعر الحد الأقصى للتقييم:</div>
                            <div class="calc-value">${capPrice.toFixed(4)} ريال عماني/سهم</div>
                        </div>
                        <div class="calculation-row">
                            <div class="calc-label">السعر النهائي (الأقل من الاثنين):</div>
                            <div class="calc-value">${conversionPrice.toFixed(4)} ريال عماني/سهم</div>
                        </div>
                        ${shariahConcern}
                        <div class="final-outcome">
                            النتيجة النهائية: ${formatNumber(shares)} سهم بقيمة ${formatNumber(Math.round(totalAmount))} ريال عماني
                        </div>
                    `;
                    break;

                case 'ebitda':
                    const ebitdaPrice = CONTRACT.valuationCap / variables.currentShares;
                    const ebitdaShares = Math.floor(totalAmount / ebitdaPrice);
                    const achieved = variables.ebitdaAchieved >= CONTRACT.ebitdaTarget;
                    
                    result = `
                        <h3>📊 سيناريو تحقيق الأرباح</h3>
                        <div class="calculation-row">
                            <div class="calc-label">الهدف المطلوب:</div>
                            <div class="calc-value">${formatNumber(CONTRACT.ebitdaTarget)} ريال عماني</div>
                        </div>
                        <div class="calculation-row">
                            <div class="calc-label">الأرباح المحققة:</div>
                            <div class="calc-value">${formatNumber(variables.ebitdaAchieved)} ريال عماني</div>
                        </div>
                        <div class="calculation-row">
                            <div class="calc-label">حالة التحقق:</div>
                            <div class="calc-value">${achieved ? '✅ تحقق' : '❌ لم يتحقق'}</div>
                        </div>
                        ${achieved ? `
                            <div class="calculation-row">
                                <div class="calc-label">سعر التحويل:</div>
                                <div class="calc-value">${ebitdaPrice.toFixed(4)} ريال عماني/سهم</div>
                            </div>
                            <div class="final-outcome">
                                يمكن التحويل اختيارياً إلى: ${formatNumber(ebitdaShares)} سهم
                            </div>
                        ` : `
                            <div class="warning-box" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                                لم يتحقق هدف الأرباح بعد - لا يمكن التحويل في هذا السيناريو
                            </div>
                        `}
                    `;
                    break;

                case 'optional':
                    const optPrice = CONTRACT.valuationCap / variables.currentShares;
                    const optShares = Math.floor(totalAmount / optPrice);
                    const available = new Date(variables.currentDate) >= new Date(CONTRACT.optionalDate);
                    
                    result = `
                        <h3>🔄 سيناريو التحويل الاختياري</h3>
                        <div class="calculation-row">
                            <div class="calc-label">تاريخ البداية:</div>
                            <div class="calc-value">${CONTRACT.optionalDate}</div>
                        </div>
                        <div class="calculation-row">
                            <div class="calc-label">التاريخ الحالي:</div>
                            <div class="calc-value">${variables.currentDate}</div>
                        </div>
                        <div class="calculation-row">
                            <div class="calc-label">الحالة:</div>
                            <div class="calc-value">${available ? '✅ متاح' : '⏳ غير متاح بعد'}</div>
                        </div>
                        ${available ? `
                            <div class="calculation-row">
                                <div class="calc-label">سعر التحويل:</div>
                                <div class="calc-value">${optPrice.toFixed(4)} ريال عماني/سهم</div>
                            </div>
                            <div class="final-outcome">
                                يمكن التحويل اختيارياً إلى: ${formatNumber(optShares)} سهم
                            </div>
                        ` : `
                            <div class="warning-box" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                                التحويل الاختياري غير متاح حتى ${CONTRACT.optionalDate}
                            </div>
                        `}
                    `;
                    break;

                case 'backstop':
                    const fmvPrice = Math.min(variables.fairMarketValue, CONTRACT.valuationCap / variables.currentShares);
                    const backstopShares = Math.floor(totalAmount / fmvPrice);
                    
                    result = `
                        <h3>⏰ سيناريو الاستحقاق</h3>
                        <div class="calculation-row">
                            <div class="calc-label">تاريخ الاستحقاق:</div>
                            <div class="calc-value">${CONTRACT.maturityDate}</div>
                        </div>
                        <div class="calculation-row">
                            <div class="calc-label">القيمة السوقية العادلة:</div>
                            <div class="calc-value">${variables.fairMarketValue.toFixed(4)} ريال عماني/سهم</div>
                        </div>
                        <div class="calculation-row">
                            <div class="calc-label">الحد الأقصى للتقييم:</div>
                            <div class="calc-value">${(CONTRACT.valuationCap / variables.currentShares).toFixed(4)} ريال عماني/سهم</div>
                        </div>
                        <div class="calculation-row">
                            <div class="calc-label">السعر الفعلي (الأقل):</div>
                            <div class="calc-value">${fmvPrice.toFixed(4)} ريال عماني/سهم</div>
                        </div>
                        <div class="final-outcome">
                            الخيارات: أ) ${formatNumber(Math.round(totalAmount))} ريال عماني نقداً<br>
                            ب) ${formatNumber(backstopShares)} سهم
                        </div>
                    `;
                    break;
            }

            // Always show interest calculation (the main Shariah concern)
            const interestWarning = `
                <div class="warning-box" style="margin: 20px 0;">
                    <strong>🚫 ربا النسيئة:</strong> فائدة متراكمة = ${formatNumber(Math.round(interest))} ريال عماني 
                    (${CONTRACT.interestRate}% × ${Math.ceil((new Date(variables.currentDate) - new Date(CONTRACT.issuanceDate)) / (1000 * 60 * 60 * 24))} يوم ÷ 365)
                    <br><strong>هذا محرم شرعاً بالإجماع</strong>
                </div>
            `;

            container.innerHTML = interestWarning + result;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    currentScenario = this.dataset.scenario;
                    updateScenarioInputs(currentScenario);
                });
            });

            updateScenarioInputs('equity');
        });
    </script>
</body>
</html>
